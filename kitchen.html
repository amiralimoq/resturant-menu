<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù¾Ù†Ù„ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Tahoma'; background: #333; color: white; padding: 20px; }
        .order-card { background: #444; border: 2px solid #f39c12; margin-bottom: 20px; padding: 15px; border-radius: 10px; }
        .new-order { animation: flash 1s; }
        @keyframes flash { 0% { background-color: white; } 100% { background-color: #444; } }
        ul { list-style: none; padding: 0; }
        li { border-bottom: 1px solid #555; padding: 5px 0; }
    </style>
</head>
<body>
    <h1>ğŸ‘¨â€ğŸ³ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ</h1>
    <div id="orders-list"></div>

    <script>
        const supabaseUrl = 'https://evdgfokcypawlaxgzxdg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2ZGdmb2tjeXBhd2xheGd6eGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxOTQzNTgsImV4cCI6MjA4MDc3MDM1OH0.XF2C5GeANSetMkoyVDIDFWMNvmtDU9beP70ZwGHV3M0';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const ordersContainer = document.getElementById('orders-list');

        // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´
        function addOrderToPage(order) {
            const div = document.createElement('div');
            div.className = 'order-card new-order';
            
            let itemsHtml = '';
            order.items.forEach(item => {
                itemsHtml += `<li>${item.name} - ØªØ¹Ø¯Ø§Ø¯: ${item.quantity}</li>`;
            });

            div.innerHTML = `
                <h3>Ù…ÛŒØ²: ${order.table_number} | ${order.customer_name}</h3>
                <ul>${itemsHtml}</ul>
                <p>Ù…Ø¬Ù…ÙˆØ¹: ${order.total_price.toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
                <small>${new Date(order.created_at).toLocaleTimeString()}</small>
            `;
            ordersContainer.prepend(div);
        }

        // 1. Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        async function fetchOrders() {
            let { data: orders } = await supabase
                .from('orders')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);
            if(orders) orders.forEach(order => addOrderToPage(order));
        }

        // 2. Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ (Real-time)
        supabase
            .channel('orders')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, payload => {
                console.log('Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯!', payload);
                addOrderToPage(payload.new);
                // Ù¾Ø®Ø´ ØµØ¯Ø§ÛŒ Ø²Ù†Ú¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
                new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
            })
            .subscribe();

        fetchOrders();
    </script>
</body>
</html>
